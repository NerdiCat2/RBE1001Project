// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft      line          G
// LineTrackerRight     line          H
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// RangeFinder          sonar         E, F
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft      line          G
// LineTrackerRight     line          H
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft      line          G
// LineTrackerRight     line          H
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft      line          G
// LineTrackerH         line          H
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerG         line          G
// LineTrackerH         line          H
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerG         line          G
// LineTrackerRight         line          B
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive          motor_group   2, 10
// Left_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive          motor_group   2, 10
// LEFT_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// RIght                motor_group   2, 10
// LEFT_Drive           motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// RIght                motor_group   2, 10
// LEFT                 motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// LEFT                 motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Push                 motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// Motor7               motor         7
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// ---- END VEXCODE CONFIGURED DEVICES ----
// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   3, 8
// arm                  motor         5
// ---- END VEXCODE CONFIGURED DEVICES ----

#include "main.h"
#include "vex.h"
#include <iostream>
#include <math.h>

// ---- START VEXCODE CONFIGURED DEVICES ----
// Robot Configuration:
// [Name]               [Type]        [Port(s)]
// LineTrackerLeft         line          A
// LineTrackerRight         line          B
// Right_Drive              motor_group   2, 10
// Left_Drive               motor_group   1, 9
// doors                motor_group   6, 8
// arm                  motor         5
// ---- END VEXCODE CONFIGURED DEVICES ----

using namespace std;

double wheelDiameter = 10.16;
double track = 28.4;
int globalRpm = 100;
double armPos = 3600; // arm starts all the way up
double pusherPos = 0; // pusher starts primed
double doorPos = 0;   // door starts closed
// double pusherposition

enum ArmPositions { Up = 3600, Ramp = 1000, Dump = 500, Down = 0, Park = 100 };
enum pusherPositions { primed, fire };
enum doorPositions {
  Open,
  Close,
};
enum Direction { Forward = 1, Backward = -1 };
int main() {
  vexcodeInit();
  cout << "starting..." << endl;
  demoDay2();
  //reset();
  // armTo(Up);
  // armUp(3600);
  // lineFollow(1.5);
  // armTo(Down);
  // openDoors();
  // goTillLine();

  cout << "end" << endl;
}

// Given a target distance, drive straight for the given distance.
void move(double cm) {
  cout << "moving " << cm << "cm..." << endl;
  double degree = distanceToDegree(cm);
  Left_Drive.rotateFor(degree, deg, globalRpm, rpm, false);
  Right_Drive.rotateFor(degree, deg, globalRpm, rpm);
}
void slowMove(double cm) {
  cout << "moving slowly " << cm << "cm..." << endl;
  double degree = distanceToDegree(cm);
  Left_Drive.rotateFor(degree, deg, 10, rpm, false);
  Right_Drive.rotateFor(degree, deg, 10, rpm);
}

// Given a target angle turn the BaseBot a specified angle.
void turnAngle(double angle) {
  cout << "turning " << angle << "degree..." << endl;
  double cm = (track * M_PI * angle) / 360;
  double degree = distanceToDegree(cm);
  Left_Drive.rotateFor(degree, deg, globalRpm, rpm, false);
  Right_Drive.rotateFor(-degree, deg, globalRpm, rpm);
}

// Changes Distance in cm to degrees
double distanceToDegree(double cm) {
  return (cm * 360 * 5) / (wheelDiameter * M_PI);
}

// Proportional Control
// turn speed = k*(sens1-sens2)
void lineFollow(double k) {
  double turnSpeed;
  vex::task::sleep(1000);
  Left_Drive.spin(fwd);
  Right_Drive.spin(fwd);
  timer f = timer();
  while (true) {
    turnSpeed =
        k * (LineTrackerLeft.reflectivity() - LineTrackerRight.reflectivity());
    cout << LineTrackerLeft.reflectivity(pct) << "   "
         << LineTrackerRight.reflectivity(pct) << "turn speed: " << turnSpeed
         << endl;
    Left_Drive.setVelocity(100 - turnSpeed, rpm);
    Right_Drive.setVelocity(100 + turnSpeed, rpm);
    vex::task::sleep(30);
    cout << "Dist" << RangeFinder.distance(distanceUnits::cm) << endl;
    // if (f.time()>10000){
    //   armTo(700);
    // }
    if (f.time() > 10000 && RangeFinder.distance(distanceUnits::cm) <= 6) {
      cout << "stoooping" << endl;
      Left_Drive.setVelocity(0, rpm);
      Right_Drive.setVelocity(0, rpm);
      break;
    }
  }
}

void openDoors() { doors.rotateTo(105, deg, 60, rpm); }

void closeDoors() {
  while (true) {
    static timer t = timer();
    doors.rotateTo(0, deg, 10, rpm, false);
    if (t.time() < 1400 && doors.velocity(rpm) < 5) {
      cout << "backing: " << t.time() << endl;
      slowMove(-2.0);
      timer t = timer();
      doors.rotateTo(0, deg, 10, rpm);
    } else if (t.time() >= 1850) {
      cout << "winding up slappy " << t.time() << endl;
      doors.rotateTo(30, deg, 5, rpm);
      cout << "slappy " << t.time() << endl;
      doors.rotateTo(0, deg, 60, rpm);
      break;
    }
  }
}

void armUp(double d) { arm.rotateFor(d, deg, globalRpm, rpm); }

void armTo(double pos) {
  armUp(pos - armPos);
  armPos = pos;
}

void BlastBalls() { 
  Push.rotateTo(130, deg, 100, rpm);
  vex::task::sleep(100);
  Push.rotateTo(0, deg, 100, rpm);
  vex::task::sleep(100);
  Push.rotateTo(130, deg, 100, rpm);
  Push.rotateTo(0, deg, 100, rpm);
  vex::task::sleep(100);
  Push.rotateTo(130, deg, 100, rpm);
   }
void ResetPusher() { Push.rotateTo(0, deg, 30, rpm); }

void goTillLine(int directionMod) {
  Right_Drive.spin(fwd, directionMod * globalRpm, rpm);
  Left_Drive.spin(fwd, directionMod * globalRpm, rpm);
  while (true) {
    double old = LineTrackerLeft.reflectivity(pct);
    vex::task::sleep(10);
    if (LineTrackerLeft.reflectivity(pct) > old &&
        LineTrackerLeft.reflectivity(pct) > 8 &&
        LineTrackerRight.reflectivity(pct) > 8) {
      Right_Drive.stop();
      Left_Drive.stop();
      cout << "stop" << endl;
      break;
    }
  }
}

void demoDay() {
  // move(-35.0);
  // turnAngle(-90);
  // armUp(-3600);
  // openDoors();
  // move(100.0);
  // armTo(Ramp);
  move(5.0);
  turnAngle(90);
  goTillLine(Forward);
  move(-20.0);
  armTo(Ramp);
  openDoors();
  armTo(Down);
  move(10.0);
  doors.rotateTo(90, deg, 10, rpm);
  slowMove(7.0);
  closeDoors();
  armTo(Dump);
  goTillLine(Backward);
  turnAngle(-90);
  armTo(Ramp);
  lineFollow(1.5);
  move(6.0);
  armTo(Dump);
  openDoors();
  BlastBalls();
  armTo(Dump+150);
  move(4.0);
  armTo(Park);
  doors.rotateTo(180,deg, 10, rpm);
}

void demoDay2() {
  // move(-35.0);
  // turnAngle(-90);
  // armUp(-3600);
  // openDoors();
  // move(100.0);
  // armTo(Ramp);
  move(5.0);
  turnAngle(-90);
  goTillLine(Forward);
  move(-20.0);
  armTo(Ramp);
  openDoors();
  armTo(Down);
  move(10.0);
  doors.rotateTo(90, deg, 10, rpm);
  slowMove(7.0);
  closeDoors();
  armTo(Dump);
  goTillLine(Backward);
  turnAngle(90);
  armTo(Ramp);
  lineFollow(1.5);
  move(6.0);
  armTo(Dump);
  openDoors();
  BlastBalls();
  armTo(Dump+150);
  move(4.0);
  armTo(Park);
  doors.rotateTo(180,deg, 10, rpm);
}


void reset(){
  ResetPusher();
  closeDoors();
  armTo(Up);
}